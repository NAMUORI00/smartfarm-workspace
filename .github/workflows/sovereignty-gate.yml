name: sovereignty-gate

on:
  pull_request:
  push:
    branches: ["main", "master"]

jobs:
  sovereignty-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install search test deps
        run: |
          python -m venv smartfarm-search/.venv
          smartfarm-search/.venv/bin/pip install --upgrade pip
          smartfarm-search/.venv/bin/pip install pytest fastapi pydantic python-dotenv httpx uvicorn redis

      - name: Sovereignty gate
        run: |
          bash scripts/ci/check_sovereignty_gate.sh

      - name: Version suffix policy gate
        run: |
          bash scripts/policy/check_version_suffixes.sh

      - name: Unit/integration tests
        run: |
          cd smartfarm-search
          .venv/bin/python -m pytest -q -s tests/unit tests/integration

      - name: Local E2E gate (mock llama)
        run: |
          smartfarm-search/.venv/bin/python scripts/ci/run_local_e2e.py --workspace . --py-bin smartfarm-search/.venv/bin/python
