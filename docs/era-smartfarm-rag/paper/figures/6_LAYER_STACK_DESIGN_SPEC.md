# ERA-SmartFarm-RAG 6-Layer 스택 디자인 명세서

> **목적**: 디자이너가 이 문서만 보고 바로 시스템 아키텍처 Figure를 그릴 수 있도록 작성

---

## 한눈에 보기

```
┌─────────────────────────────────────────────────────────────┐
│  Layer 5: Application        │  UI, API, 정책              │
├─────────────────────────────────────────────────────────────┤
│  Layer 4: Generation         │  LLM 응답 생성              │
├─────────────────────────────────────────────────────────────┤
│  Layer 3: Context Shaping    │  ⭐ 핵심 기여 (토큰 절감)    │
├─────────────────────────────────────────────────────────────┤
│  Layer 2: Retrieval          │  3채널 검색 엔진            │
├─────────────────────────────────────────────────────────────┤
│  Layer 1: Knowledge Store    │  지식 저장소                │
├─────────────────────────────────────────────────────────────┤
│  Layer 0: Device & Runtime   │  하드웨어/런타임 제약        │
└─────────────────────────────────────────────────────────────┘
```

**데이터 흐름**: 위에서 아래로 (Layer 5 → 0), 응답은 아래에서 위로

---

## Layer별 상세 명세

---

### Layer 0: Device & Runtime

**역할**: 하드웨어 제약과 런타임 환경 정의

**배경색**: 갈색 계열 (`#EFEBE9`)

**박스 3개**:

| 박스 | 이름 | 내용 | 아이콘 제안 |
|------|------|------|------------|
| 1 | LLM Runtime | `llama.cpp`<br>`Qwen3-0.6B`<br>`Q4_K_M (~400MB)` | 뇌/CPU |
| 2 | Embedding | `MiniLM (90MB)`<br>또는 `Qwen3-Emb` | 벡터/화살표 |
| 3 | Vector DB | `FAISS`<br>`mmap enabled` | 데이터베이스 |

**상단 라벨 (뱃지)**: `⚡ 8GB RAM` `Q4 Quantization`

**디자인 포인트**:
- 가장 아래에 위치 (기반 레이어)
- 하드웨어 느낌의 딱딱한 테두리
- 제약 조건을 강조하는 경고 색상 뱃지

---

### Layer 1: On-device Knowledge Store

**역할**: 검색 가능한 지식 데이터 저장

**배경색**: 연보라 (`#F3E5F5`)

**구성 요소 (2행)**:

**1행 - 인덱스 파일 3개**:

| 박스 | 이름 | 설명 |
|------|------|------|
| 1 | Dense Index | `dense.faiss`<br>(mmap 지원) |
| 2 | Sparse Index | `sparse.pkl`<br>(TF-IDF) |
| 3 | Causal Graph | `causes` / `solved_by`<br>인과관계 엣지 |

**2행 - 온톨로지 (가로로 긴 박스 1개)**:

```
Domain Ontology (6 types)
┌────────┬────────┬──────────┬─────────┬────────┬──────────┐
│  crop  │  env   │ nutrient │ disease │ stage  │ practice │
│  작물  │  환경  │   영양   │   병해  │ 생육   │  재배    │
└────────┴────────┴──────────┴─────────┴────────┴──────────┘
```

**디자인 포인트**:
- Layer 0과 Layer 2 사이에 **점선 경계** 표시 (RAM ↔ Flash 구분)
- 인덱스 파일들은 디스크 아이콘과 함께

---

### Layer 2: Retrieval Core

**역할**: 3채널 하이브리드 검색 엔진

**배경색**: 파랑 계열 (`#E3F2FD`)

**테두리**: 두꺼운 실선 (중요 컴포넌트)

**구조**:

```
┌─────────────────────────────────────────────────────────────┐
│            HybridDATRetriever (Dynamic Alpha Tuning)         │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐    │
│  │    Dense      │  │    Sparse     │  │  PathRAG-lite │    │
│  │   (FAISS)     │  │   (TF-IDF)    │  │ (Graph BFS)   │    │
│  │     α_d       │  │     α_s       │  │     α_p       │    │
│  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘    │
│          │                  │                  │            │
│          └──────────────────┼──────────────────┘            │
│                             ▼                               │
│               Score Normalization & Fusion                  │
└─────────────────────────────────────────────────────────────┘
```

**3채널 색상 구분**:

| 채널 | 색상 | 설명 |
|------|------|------|
| Dense | 진한 파랑 (`#BBDEFB`) | 의미 기반 검색 |
| Sparse | 연두 (`#C8E6C9`) | 키워드 매칭 |
| PathRAG | 분홍 (`#F8BBD0`) | 그래프 탐색 |

**화살표**: 세 채널에서 하나로 모이는 융합 화살표

**디자인 포인트**:
- 3개 박스가 병렬로 나란히
- 아래로 합쳐지는 화살표 (융합 표현)
- α 기호로 가중치 표시

---

### Layer 3: Context Shaping ⭐

**역할**: 검색 결과 정제 및 토큰 절감 (논문 핵심 기여)

**배경색**: 노랑 계열 (`#FFF9C4`)

**테두리**: **굵은 강조 테두리** (핵심 기여 표시)

**라벨**: `🎯 논문 핵심 기여` 또는 `⭐ Key Contribution`

**박스 3개 (왼쪽→오른쪽 순서)**:

| 순서 | 박스 | 내용 | 효과 |
|------|------|------|------|
| 1 | Crop Filter | 작물 필터링<br>`+0.5` / `×0.15` | 도메인 정확도 |
| 2 | Semantic Dedup | 중복 제거<br>`θ = 0.85` | 다양성 확보 |
| 3 | Memory-aware Reranking | RAM 적응형<br>`BGE / LLM-lite / none` | 품질 향상 |

**화살표 흐름**:
```
입력 (16 docs) → [Crop Filter] → (12 docs) → [Semantic Dedup] → (8 docs) → [Reranking] → 출력 (4 docs)
```

**디자인 포인트**:
- **가장 눈에 띄게** (논문의 핵심 기여)
- 문서 수 감소를 화살표 위에 표시
- 노란 배경 + 굵은 테두리로 강조

---

### Layer 4: Generation & Grounding

**역할**: LLM 기반 응답 생성 및 폴백

**배경색**: 연두 (`#E8F5E9`)

**박스 2개**:

| 박스 | 이름 | 설명 |
|------|------|------|
| 1 | Prompt Template | `Jinja2` 기반<br>RAG 프롬프트 빌드 |
| 2 | TemplateResponder | 오프라인 폴백<br>온톨로지 기반 정형 응답 |

**연결**: 두 박스 사이에 "OR" 또는 분기 표시

**디자인 포인트**:
- 정상 경로와 폴백 경로 구분
- TemplateResponder는 점선 테두리 (대체 경로)

---

### Layer 5: Application & Policy

**역할**: 사용자 인터페이스 및 정책

**배경색**: 밝은 회색 (`#FAFAFA`) 또는 흰색

**박스 3개**:

| 박스 | 이름 | 설명 |
|------|------|------|
| 1 | Streamlit UI | 시각화 대시보드 |
| 2 | FastAPI REST | `/query` `/ingest` `/health` |
| 3 | Offline Fallback Policy | `Cache → Template → Search` |

**디자인 포인트**:
- 가장 위에 위치 (사용자와 가장 가까움)
- 깔끔하고 심플한 디자인

---

## 전체 레이아웃 가이드

### 크기 비율 (세로)

```
Layer 5: ████████████████████  (15%)
Layer 4: ████████████████████  (15%)
Layer 3: ██████████████████████████████  (20%) ← 강조
Layer 2: ██████████████████████████████  (20%) ← 강조
Layer 1: ████████████████████  (15%)
Layer 0: ████████████████████  (15%)
```

### 색상 팔레트

| Layer | 색상명 | HEX | RGB |
|-------|--------|-----|-----|
| 5 | 밝은 회색 | `#FAFAFA` | 250, 250, 250 |
| 4 | 연두 | `#E8F5E9` | 232, 245, 233 |
| 3 | 노랑 ⭐ | `#FFF9C4` | 255, 249, 196 |
| 2 | 파랑 | `#E3F2FD` | 227, 242, 253 |
| 1 | 연보라 | `#F3E5F5` | 243, 229, 245 |
| 0 | 갈색 | `#EFEBE9` | 239, 235, 233 |

### 특수 표시

| 요소 | 표현 방법 |
|------|----------|
| 핵심 기여 (Layer 3) | 굵은 테두리 + ⭐ 아이콘 |
| RAM↔Flash 경계 | Layer 1-2 사이 점선 |
| 리소스 제약 | Layer 0 상단에 뱃지 |
| 데이터 흐름 | 위→아래 화살표 |

---

## 간략 버전 (미니멀)

**논문에 작게 들어갈 경우**:

```
┌─────────────────────────────────────┐
│ L5: UI / API                        │
├─────────────────────────────────────┤
│ L4: LLM Generation                  │
├━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥  ← 굵은 선
│ L3: Context Shaping ⭐              │
├━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥  ← 굵은 선
│ L2: 3-Channel Hybrid Retrieval      │
├┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┤  ← 점선 (RAM/Flash)
│ L1: Knowledge Store + Ontology      │
├─────────────────────────────────────┤
│ L0: llama.cpp + FAISS (8GB RAM)     │
└─────────────────────────────────────┘
```

---

## 체크리스트 (디자이너용)

### 필수 요소
- [ ] 6개 레이어가 수직으로 쌓여있음
- [ ] Layer 3이 가장 강조됨 (논문 핵심)
- [ ] Layer 2에 3개 채널이 병렬로 표시됨
- [ ] Layer 0에 "8GB RAM" 제약 표시됨
- [ ] Layer 1-2 사이에 RAM/Flash 경계 점선

### 권장 요소
- [ ] 각 Layer별 색상 구분
- [ ] 데이터 흐름 화살표 (위→아래)
- [ ] 3채널 융합 화살표 (3개→1개)
- [ ] 문서 수 감소 표시 (16→12→8→4)

### 선택 요소
- [ ] 아이콘 (뇌, 벡터, DB, 필터 등)
- [ ] 그림자/입체 효과
- [ ] 배경 그라데이션

---

## 참고: 실제 코드 매핑

| Layer | 주요 파일 |
|-------|----------|
| 5 | `frontend/streamlit/`, `core/Api/routes_*.py` |
| 4 | `core/Services/LLM.py`, `core/Services/TemplateResponder.py` |
| 3 | `core/Services/Retrieval/Hybrid.py` (`_deduplicate`, `_apply_crop_filter`) |
| 2 | `core/Services/Retrieval/Hybrid.py`, `PathRAG.py`, `Sparse.py` |
| 1 | `core/Api/deps.py`, `core/Services/Ontology.py` |
| 0 | `core/Config/Settings.py` |
