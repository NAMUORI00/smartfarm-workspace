% Section 3: Methodology
% Converted from: 03_methodology.md

\section{제안 방법론 (Proposed Methodology)}
\label{sec:methodology}

\subsection{시스템 아키텍처 개요}

본 시스템은 스마트팜 도메인에 특화된 온디바이스 하이브리드 RAG로, 6계층 스택 아키텍처로 구성된다.

\subsubsection{리소스 제약 및 설계 목표}

엣지 환경의 리소스 제약을 명확히 정의하고, 이를 기반으로 각 컴포넌트를 설계하였다.

\input{tables/methodology/resource-constraints}

\subsubsection{6계층 아키텍처}

% [Figure 1 placeholder - 6-layer architecture diagram]
\begin{figure}[htbp]
	\centering
	\fbox{\parbox{0.9\textwidth}{\centering \textbf{[Figure 1: 6-Layer Stack Architecture]} \\[1em]
			L5: Application \& Policy (Streamlit UI, FastAPI REST, Offline Fallback) \\
			L4: Generation \& Grounding (Prompt Template, TemplateResponder) \\
			L3: Context Shaping (Crop Filter, Semantic Dedup, Reranking) \\
			L2: Retrieval Core (Dense/Sparse/PathRAG 3-channel) \\
			L1: On-device Knowledge Store (FAISS, Causal Graph, Ontology) \\
			L0: Device \& Runtime (llama.cpp, Embedding, FAISS mmap)
		}}
	\caption{제안 시스템의 6계층 스택 아키텍처}
	\label{fig:architecture}
\end{figure}

\textbf{계층별 핵심 역할}:

\input{tables/methodology/layers}

\subsection{스마트팜 온톨로지}

\subsubsection{설계 배경}

온톨로지 설계는 Stanford 온톨로지 구축 방법론~\cite{ref13}과 기존 농업 온톨로지 연구~\cite{ref9,ref10,ref11}를 참조하여 스마트팜 도메인에 적합한 6개 개념 유형을 정의하였다. CropDP-KG~\cite{ref12}의 엔티티 구조와 AgriKG~\cite{ref21}의 농업 엔티티 분류를 참고하여 한국 스마트팜 환경에 맞게 구성하였다.

\subsubsection{개념 유형 정의}

\input{tables/methodology/ontology}

각 개념은 동의어/유의어 목록(alias)을 포함한다. 예를 들어 ``와사비''의 alias에는 ``산와사비'', ``본와사비''가 포함되어 사용자가 어떤 표현을 쓰더라도 동일 개념으로 인식한다.

\subsection{3채널 하이브리드 검색 (HybridDAT)}

\subsubsection{설계 근거}

Dense retrieval은 의미적 유사성 검색에 강하지만 ``EC 2.5 dS/m'' 같은 수치 정보 매칭에 취약하다. Sparse retrieval은 정확한 키워드 매칭에 강하지만 의미적 유사성을 놓칠 수 있다~\cite{ref5}. 본 시스템은 Dense-Sparse-PathRAG 3채널 융합과 질의 특성에 따른 동적 가중치 조정(Dynamic Alpha Tuning)을 적용한다.

\subsubsection{HybridDATRetriever 플로우}

% [Figure 2 placeholder - HybridDAT flow diagram]
\begin{figure}[htbp]
	\centering
	\fbox{\parbox{0.9\textwidth}{\centering \textbf{[Figure 2: HybridDAT Retrieval Flow]} \\[1em]
			1. Query $\rightarrow$ Ontology Matching \\
			2. Dynamic Alpha Calculation (수치/병해 분석) \\
			3. 3-Channel Parallel Search (Dense/Sparse/PathRAG) \\
			4. Score Fusion (Min-Max Normalization + Weighted Sum) \\
			5. Top-k $\times$ 2 Candidates
		}}
	\caption{HybridDATRetriever 검색 플로우}
	\label{fig:hybriddat}
\end{figure}

\subsubsection{동적 가중치 규칙 (Dynamic Alpha)}

질의 내용을 분석하여 가중치를 자동 결정한다:

\input{tables/methodology/dynamic-alpha}

\subsection{인과관계 그래프 (PathRAG-lite)}

\subsubsection{설계 배경}

농업 도메인에서 ``고수온 $\rightarrow$ 연부병 발생 $\rightarrow$ 수온 관리'' 같은 인과 체인이 핵심 정보 구조를 형성한다~\cite{ref17}. GraphRAG~\cite{ref7}는 LLM으로 개체와 관계를 추출하므로 구축 비용이 높다(문서 1000개당 GPT-4 \$100+). 본 시스템은 규칙 기반 패턴 매칭으로 인과관계 그래프를 구축하여 비용을 \$0으로 절감한다.

\subsubsection{인과관계 역할 분류}

텍스트 패턴 매칭으로 문서의 역할을 분류한다:

\input{tables/methodology/causal-patterns}

\subsubsection{PathRAG-lite BFS 탐색}

PathRAG~\cite{ref8}의 경로 탐색 개념을 차용한 경량 구현이다. BFS(너비 우선 탐색) 기반 2-hop 탐색으로 원인$\rightarrow$결과$\rightarrow$해결책 문서를 수집한다.

\subsubsection{그래프 스키마}

CropDP-KG~\cite{ref12}와 AgriKG~\cite{ref21}의 스키마 설계를 참조하여 구성하였다.

\textbf{노드 타입}: practice(문서), crop, env, disease, nutrient, stage

\textbf{엣지 타입}:
\begin{itemize}
	\item \texttt{recommended\_for}: 작물 $\rightarrow$ 실천 (AgriKG~\cite{ref21})
	\item \texttt{associated\_with}: 병해 $\rightarrow$ 실천 (CropDP-KG~\cite{ref12})
	\item \texttt{mentions}: 실천 $\rightarrow$ 개념 (농업 온톨로지~\cite{ref10})
	\item \texttt{causes}: 실천 $\rightarrow$ 실천 (인과 추출~\cite{ref14,ref15})
	\item \texttt{solved\_by}: 실천 $\rightarrow$ 실천 (인과 추출~\cite{ref14,ref15})
\end{itemize}

\subsection{Context Shaping (컨텍스트 압축)}

엣지 LLM은 토큰이 곧 지연/전력 비용이므로, 검색 결과를 그대로 전달하지 않고 압축/필터링하는 것이 핵심이다.

\subsubsection{Context Shaping 파이프라인}

% [Figure 3 placeholder - Context Shaping pipeline]
\begin{figure}[htbp]
	\centering
	\fbox{\parbox{0.9\textwidth}{\centering \textbf{[Figure 3: Context Shaping Pipeline]} \\[1em]
			Input (16 docs) $\rightarrow$ Crop Filter ($\sim$12 docs) \\
			$\rightarrow$ Semantic Dedup ($\sim$8 docs) $\rightarrow$ Reranking $\rightarrow$ Output (4 docs)
		}}
	\caption{Context Shaping 파이프라인}
	\label{fig:context_shaping}
\end{figure}

\subsubsection{작물 필터링 (Crop-aware Filtering)}

농업 지식 그래프 연구~\cite{ref4,ref12}에서 작물별 맥락 의존성이 강조되었다. 질의의 작물과 문서의 작물 메타데이터를 비교하여 스코어를 조정한다.

\input{tables/methodology/crop-filter}

\subsubsection{시맨틱 중복 제거 (Semantic Deduplication)}

MMR~\cite{ref18}과 VRSD~\cite{ref19}를 참조하여 검색 결과의 다양성을 확보한다. 두 문서의 임베딩 벡터 간 코사인 유사도가 임계값($\theta$=0.85) 이상인 문서 쌍에서 후순위 문서를 제거한다.

\subsubsection{메모리 적응형 리랭킹}

런타임 가용 메모리에 따라 리랭커를 동적으로 선택한다:

\input{tables/methodology/reranking}

\subsection{엣지 배포 최적화}

\subsubsection{메모리 계층 구조 (RAM vs Flash)}

엣지 환경에서 ``벡터 인덱스가 RAM에 다 못 올라간다''는 병목을 해결하기 위해 계층적 메모리 구조를 설계하였다.

\begin{itemize}
	\item \textbf{RAM (Hot Data)}: Query Cache (LRU 128), Embedding Cache (LRU 256), FAISS mmap Active Pages, LLM Weights ($\sim$2.5GB)
	\item \textbf{Flash/SSD (Cold Data)}: dense.faiss (mmap), sparse.pkl, responses.jsonl, graph.json
\end{itemize}

\subsubsection{LLM 양자화 전략}

llama.cpp의 GGUF 포맷~\cite{ref23}을 활용하여 Q4\_K\_M 양자화를 기본으로 적용한다.

\input{tables/methodology/quantization}

Q4\_K\_M은 중요한 레이어는 5비트, 나머지는 4비트로 혼합 양자화하여 품질 대비 메모리 효율의 최적점으로 평가된다.

\subsubsection{오프라인 폴백 모드}

네트워크 단절 또는 LLM 장애 시 다음과 같은 폴백 전략을 적용한다:

\begin{enumerate}
	\item \textbf{Similar Cache}: ResponseCache.get\_similar() - 임베딩 유사도 $\geq$ 0.9인 이전 유사 질의 응답 재활용
	\item \textbf{Template Response}: TemplateResponder.generate() - 온톨로지 매칭 기반 정형화된 응답 생성
	\item \textbf{Search Only}: LLM 없이 검색 결과만 반환
\end{enumerate}

\subsection{관련 연구와의 비교}

\input{tables/methodology/comparison}
