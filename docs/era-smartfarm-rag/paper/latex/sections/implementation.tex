% Section 4: Implementation
% Converted from: 04_implementation.md

\section{시스템 구현 (Implementation)}
\label{sec:implementation}

\subsection{기술 스택}

\input{tables/implementation/tech-stack}

\subsection{핵심 모듈 구현}

\subsubsection{HybridDATRetriever}

3채널 검색 융합과 후처리를 담당하는 핵심 리트리버이다.

\textbf{주요 파라미터:}
\begin{itemize}
	\item \texttt{DEDUP\_THRESHOLD}: 0.85 (시맨틱 중복 판단 임계값)
	\item \texttt{CROP\_MATCH\_BONUS}: 0.5 (작물 일치 시 스코어 보너스)
	\item \texttt{CROP\_MISMATCH\_PENALTY}: 0.85 (작물 불일치 시 패널티 계수)
\end{itemize}

\textbf{동적 가중치 계산 (\texttt{dynamic\_alphas}):}
온톨로지 매칭 결과와 수치/단위 패턴을 분석하여 3채널 가중치 반환. LLM 호출 없이 규칙 기반으로 동작하여 엣지 환경 최적화.

\subsubsection{PathRAGRetriever (PathRAG-lite)}

PathRAG~\cite{ref8}의 경로 탐색 개념을 차용한 경량 구현이다. 원본 PathRAG의 relational path pruning 대신 BFS(Breadth-First Search) 기반 단순화된 탐색을 수행한다.

\textbf{탐색 전략:}
\begin{itemize}
	\item 시작점: 쿼리에서 매칭된 온톨로지 개념 노드 (예: ``와사비 고수온'' $\rightarrow$ crop:와사비, env:고수온)
	\item 최대 깊이: 2-hop (기본값)
	\item 인과관계 엣지(\texttt{causes}, \texttt{solved\_by}) 우선 탐색
\end{itemize}

\subsubsection{GraphBuilder}

문서 인제스트 시 인과관계 그래프를 자동 구축한다.

\textbf{인과관계 패턴:}
\begin{itemize}
	\item \texttt{CAUSE\_PATTERNS}: ``원인'', ``이유'', ``때문'', ``$\sim$하면'', ``높으면'', ``낮으면''
	\item \texttt{EFFECT\_PATTERNS}: ``결과'', ``영향'', ``증상'', ``문제'', ``장애'', ``저하''
	\item \texttt{SOLUTION\_PATTERNS}: ``해결'', ``대응'', ``방법'', ``조치'', ``관리'', ``예방''
\end{itemize}

\textbf{엣지 생성 로직:}
\begin{enumerate}
	\item 각 문서의 인과관계 역할 탐지 (cause/effect/solution)
	\item 공통 키워드(작물, 환경요소, 병해, 상태) 추출
	\item 키워드 교집합이 존재하는 문서 쌍에 엣지 생성
\end{enumerate}

\subsubsection{EmbeddingRetriever}

FAISS(Facebook AI Similarity Search) 기반 Dense 검색을 담당한다.

\textbf{특징:}
\begin{itemize}
	\item Lazy loading: 시작 시가 아닌 첫 쿼리 시점에 모델 로드 $\rightarrow$ 초기 메모리 절약
	\item L2 정규화된 임베딩으로 코사인 유사도 검색
	\item mmap 지원으로 대용량 인덱스도 저메모리에서 사용 가능
\end{itemize}

\subsection{메모리 적응형 리랭킹}

런타임 가용 메모리에 따라 리랭커를 동적으로 선택한다:

\input{tables/implementation/reranking-impl}

\textbf{설정 파라미터:}
\begin{itemize}
	\item \texttt{AUTO\_RERANK\_MIN\_RAM\_GB}: 0.8
	\item \texttt{AUTO\_BGE\_MIN\_RAM\_GB}: 1.5
	\item \texttt{AUTO\_BGE\_MIN\_VRAM\_GB}: 1.5 (GPU 사용 시)
\end{itemize}

\subsection{인덱스 영속화}

오프라인 환경 지원을 위해 인덱스를 파일로 저장/로드한다:

\input{tables/implementation/index-files}

\subsection{그래프 스키마}

CropDP-KG~\cite{ref12}와 AgriKG~\cite{ref21}의 스키마 설계를 참조하여 구성하였다.

\textbf{노드 타입}: practice(문서), crop, env, disease, nutrient, stage

\textbf{엣지 타입:}

\input{tables/implementation/edge-types}

\subsection{엣지 배포 사양}

\input{tables/implementation/deployment-spec}

\subsection{EdgeRAG와의 구현 비교}

\input{tables/implementation/edgerag-comparison}

\textbf{핵심 차별점:}
\begin{enumerate}
	\item \textbf{도메인 특화}: EdgeRAG가 범용 메모리 최적화에 집중하는 반면, 본 시스템은 농업 온톨로지와 인과관계 그래프를 활용하여 검색 품질 향상
	\item \textbf{멀티 채널}: 수치/단위 정보(EC, pH)의 정확한 매칭을 위한 Sparse 채널 유지
	\item \textbf{메모리 적응형}: 런타임 가용 메모리에 따른 동적 리랭커 선택
\end{enumerate}
