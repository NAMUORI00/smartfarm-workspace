# 3. 제안 방법론 (Proposed Methodology)

## 3.1 전체 시스템 개요 및 처리 흐름

본 연구는 스마트팜 현장의 자원 제약 환경(8GB RAM)에서 근거 기반 실시간 응답을 제공하는 온디바이스 RAG 시스템을 제안한다. Figure 1은 시스템의 End-to-End 아키텍처를 **3-Column 가로 배치**로 제시한다:

- **Phase 1 (좌측, 청색)**: 데이터 수집 및 인덱스 구축 (Offline, One-time)
- **Phase 2 (중앙, 청색)**: 런타임 추론 파이프라인 (Online, Per-query)
- **Evaluation Protocol (우측, 주황색)**: Dataset 생성 + 검증/평가 방법론

### 3.1.1 End-to-End 처리 흐름 (Figure 1)

> **Figure 1: ERA-SmartFarm-RAG End-to-End Research Pipeline (3-Column Horizontal Layout)**

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                                    ERA-SmartFarm-RAG: End-to-End Research Pipeline                                              ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃  🔵 PHASE 1: Data & Index Build    ┃  🔵 PHASE 2: Runtime Inference        ┃  🟠 EVALUATION PROTOCOL                             ┃
┃      (Offline, One-time)           ┃      (Online, Per-query)              ┃      (Research Methodology)                         ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╋━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╋━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃                                    ┃                                       ┃                                                     ┃
┃  ┌──────────────────────────────┐  ┃  ┌─────────────────────────────────┐  ┃  ┌─────────────────────────────────────────────┐   ┃
┃  │ ① DATA COLLECTION            │  ┃  │ ④ QUERY ANALYSIS                │  ┃  │ DATASET GENERATION (dataset-pipeline)       │   ┃
┃  │ ─────────────────────────    │  ┃  │ ─────────────────────────       │  ┃  │ ─────────────────────────────────────       │   ┃
┃  │ Sources:                     │  ┃  │ • OntologyMatcher.match()       │  ┃  │ ┌─────────────┐  ┌─────────────────────┐    │   ┃
┃  │ • Web Crawl (Wiki, Brit.)    │  ┃  │ • Dynamic Alpha Tuning:         │  ┃  │ │Self-Instruct│─►│ Question Generation │    │   ┃
┃  │ • 농촌진흥청 PDF              │  ┃  │   ┌───────────────────────────┐ │  ┃  │ │(Wang, ACL23)│  │ Seed → Diverse Q's  │    │   ┃
┃  │ • 스마트팜코리아 가이드       │  ┃  │   │ 수치/단위 → α_s +0.2     │ │  ┃  │ └─────────────┘  └──────────┬──────────┘    │   ┃
┃  │                              │  ┃  │   │ 환경/영양 → α_s +0.1     │ │  ┃  │ ┌─────────────┐             │               │   ┃
┃  │ Format:                      │  ┃  │   │ 병해/재배 → α_p ~0.3-0.4 │ │  ┃  │ │Evol-Instruct│─►──────────►│               │   ┃
┃  │ • PDF, Images, Text          │  ┃  │   └───────────────────────────┘ │  ┃  │ │(Xu, ICLR23) │  Complexity │               │   ┃
┃  │ • EN/KO Bilingual            │  ┃  └──────────────┬──────────────────┘  ┃  │ └─────────────┘  Evolution  ▼               │   ┃
┃  └──────────────┬───────────────┘  ┃                 │                     ┃  │ ┌─────────────┐  ┌─────────────────────┐    │   ┃
┃                 │                  ┃                 ▼                     ┃  │ │    RAFT     │─►│ Answer Generation   │    │   ┃
┃                 ▼                  ┃  ┌─────────────────────────────────┐  ┃  │ │(Zhang,COLM24│  │ Context-grounded    │    │   ┃
┃  ┌──────────────────────────────┐  ┃  │ ⑤ HYBRID RETRIEVAL (HybridDAT) │  ┃  │ └─────────────┘  └──────────┬──────────┘    │   ┃
┃  │ ② PREPROCESSING              │  ┃  │ ─────────────────────────────  │  ┃  │                            │               │   ┃
┃  │ ─────────────────────────    │  ┃  │ ┌─────────┬─────────┬────────┐ │  ┃  │                            ▼               │   ┃
┃  │ • Text extraction            │  ┃  │ │  Dense  │ Sparse  │PathRAG │ │  ┃  │ ┌─────────────┐  ┌─────────────────────┐    │   ┃
┃  │ • OCR fallback (EasyOCR)     │  ┃  │ │  FAISS  │ TF-IDF  │BFS 2hop│ │  ┃  │ │LLM-as-Judge │─►│ Quality Evaluation  │    │   ┃
┃  │ • Sentence-window chunking   │  ┃  │ │  α_d    │  α_s    │  α_p   │ │  ┃  │ │(Zheng,Neu24)│  │ Groundedness check  │    │   ┃
┃  │   (CHUNK_SIZE/STRIDE)        │  ┃  │ └────┬────┴────┬────┴───┬────┘ │  ┃  │ │+ Prometheus │  │ Accuracy scoring    │    │   ┃
┃  │ • Metadata tagging:          │  ┃  │      └─────────┴────────┘      │  ┃  │ │(Kim, Neu24) │  │ Completeness eval   │    │   ┃
┃  │   crop, causal, numeric      │  ┃  │              │ Score Fusion    │  ┃  │ └─────────────┘  └──────────┬──────────┘    │   ┃
┃  │ • EN→KO Translation          │  ┃  │              ▼                 │  ┃  │                            │               │   ┃
┃  │   (gemini-2.5-flash)         │  ┃  │   final = α_d×D + α_s×S + α_p×P│  ┃  │                            ▼               │   ┃
┃  └──────────────┬───────────────┘  ┃  └──────────────┬──────────────────┘  ┃  │               ┌─────────────────────┐      │   ┃
┃                 │                  ┃                 │                     ┃  │               │ 📦 QA Dataset        │      │   ┃
┃                 ▼                  ┃                 ▼                     ┃  │               │ • 220 QA pairs       │      │   ┃
┃  ┌──────────────────────────────┐  ┃  ┌─────────────────────────────────┐  ┃  │               │ • 6 categories       │      │   ┃
┃  │ ③ KNOWLEDGE STORE            │  ┃  │ ⑥ RESULT RANKING               │  ┃  │               │ • ROUGE-L 0.93       │      │   ┃
┃  │ ─────────────────────────    │  ┃  │ ─────────────────────────────  │  ┃  │               │ • Groundedness 0.52  │      │   ┃
┃  │ ┌──────────────────────────┐ │  ┃  │                                │  ┃  │               └─────────────────────┘      │   ┃
┃  │ │ dense.faiss (mmap)       │ │  ┃  │ Score fusion → Top-k (8)       │  ┃  └─────────────────────────────────────────────┘   ┃
┃  │ │ • FAISS IndexFlatIP      │ │  ┃  │                                │  ┃                                                     ┃
┃  │ │ • MiniLM / Qwen3-Emb     │ │  ┃  │                                │  ┃  ┌─────────────────────────────────────────────┐   ┃
┃  │ ├──────────────────────────┤ │  ┃  │                                │  ┃  │ VERIFICATION                                │   ┃
┃  │ │ sparse.pkl               │ │  ┃  │                                │  ┃  │ ─────────────────────────────────────       │   ┃
┃  │ │ • TfidfVectorizer        │ │  ┃  │                                │  ┃  │ • Source Attribution                        │   ┃
┃  │ │ • Keyword matching       │ │  ┃  │                                │  ┃  │   (claim → document mapping)                │   ┃
┃  │ ├──────────────────────────┤ │  ┃  │                                │  ┃  │ • Groundedness Checks                       │   ┃
┃  │ │ Causal Graph (in-memory) │ │  ┃  │                                │  ┃  │   (keyword/source-hit verification)        │   ┃
┃  │ │ • causes, solved_by edges│ │  ┃  │                                │  ┃  │ • Numerical Consistency                     │   ┃
┃  │ │ • Built from doc metadata│ │  ┃  │                                │  ┃  │   (range/unit validation)                   │   ┃
┃  │ ├──────────────────────────┤ │  ┃  │                ▼               │  ┃  └─────────────────────────────────────────────┘   ┃
┃  │ │ ontology.json            │ │  ┃  └──────────────────────────────┬┘  ┃                                                     ┃
┃  │ │ • 6 types: crop, env,    │ │  ┃                                 │   ┃  ┌─────────────────────────────────────────────┐   ┃
┃  │ │   nutrient, disease,     │◄┼──╋───────────────mmap load─────────┘   ┃  │ ABLATION STUDY                              │   ┃
┃  │ │   stage, practice        │ │  ┃                                     ┃  │ ─────────────────────────────────────       │   ┃
┃  │ └──────────────────────────┘ │  ┃  ┌─────────────────────────────────┐  ┃  │ Component-wise Analysis:                    │   ┃
┃  │                              │  ┃  │ ⑥.5 RERANKING (Optional)       │  ┃  │ • Dense-only        (w/o Sparse, PathRAG)   │   ┃
┃  │ Statistics:                  │  ┃  │ ─────────────────────────────  │  ┃  │ • Sparse-only       (w/o Dense, PathRAG)    │   ┃
┃  │ • ~100 documents             │  ┃  │ Memory-aware selection:        │  ┃  │ • w/o PathRAG       (Dense + Sparse only)   │   ┃
┃  │ • ~400 chunks                │  ┃  │ ┌────────────────────────────┐ │  ┃  │ • w/o Ontology (no domain matching)        │   ┃
┃  │ • Bilingual EN-KO            │  ┃  │ │ RAM < 0.8GB  → none (skip) │ │  ┃  │ • w/o Dynamic Alpha (fixed α=0.5)          │   ┃
┃  └──────────────────────────────┘  ┃  │ │ 0.8-1.5GB   → LLM-lite    │ │  ┃  └─────────────────────────────────────────────┘   ┃
┃                                    ┃  │ │ ≥ 1.5GB     → BGE Reranker│ │  ┃                                                     ┃
┃                                    ┃  │ └────────────────────────────┘ │  ┃  ┌─────────────────────────────────────────────┐   ┃
┃                                    ┃  │              │ Final Top-k (4) │  ┃  │ BENCHMARK (Internal Baselines)              │   ┃
┃                                    ┃  └──────────────┬──────────────────┘  ┃  │ ─────────────────────────────────────       │   ┃
┃                                    ┃                 │                     ┃  │ Comparison Targets:                         │   ┃
┃                                    ┃                 ▼                     ┃  │ • vs Dense-only baseline                    │   ┃
┃                                    ┃  ┌─────────────────────────────────┐  ┃  │ • vs Sparse-only baseline                   │   ┃
┃                                    ┃  │ ⑦ LLM GENERATION               │  ┃  │ • vs Naive Hybrid (α=0.5 fixed)             │   ┃
┃                                    ┃  │ ─────────────────────────────  │  ┃  │                                             │   ┃
┃                                    ┃  │ llama.cpp (Qwen3-0.6B, Q4_K_M) │  ┃  │ Dimensions:                                 │   ┃
┃                                    ┃  │                                 │  ┃  │ • Retrieval Quality (Recall, Precision)    │   ┃
┃                                    ┃  │ ┌─────────────────────────────┐ │  ┃  │ • Edge Efficiency (Latency, Memory)        │   ┃
┃                                    ┃  │ │ Fallback Chain:             │ │  ┃  │ • Answer Quality (LLM-as-a-Judge)          │   ┃
┃                                    ┃  │ │ 0. Exact Cache Hit          │ │  ┃  └─────────────────────────────────────────────┘   ┃
┃                                    ┃  │ │ 1. Similar Cache (≥0.9 sim) │ │  ┃                                                     ┃
┃                                    ┃  │ │ 2. Template Response        │ │  ┃  ┌─────────────────────────────────────────────┐   ┃
┃                                    ┃  │ │ 3. Search-only Mode         │ │  ┃  │ 📊 EVALUATION METRICS                       │   ┃
┃                                    ┃  │ └─────────────────────────────┘ │  ┃  │ ─────────────────────────────────────       │   ┃
┃                                    ┃  └──────────────┬──────────────────┘  ┃  │                                             │   ┃
┃                                    ┃                 │                     ┃  │ Retrieval Quality:                          │   ┃
┃                                    ┃                 ▼                     ┃  │ • Recall@k (k=1,4,10)                       │   ┃
┃                                    ┃  ┌─────────────────────────────────┐  ┃  │ • Precision@k                               │   ┃
┃                                    ┃  │ 📤 OUTPUT                       │  ┃  │ • MRR (Mean Reciprocal Rank)                │   ┃
┃                                    ┃  │ ─────────────────────────────  │  ┃  │                                             │   ┃
┃                                    ┃  │ {                               │  ┃  │ Edge Performance:                           │   ┃
┃                                    ┃  │   answer: "와사비 적정 수온...",│  ┃  │ • End-to-end Latency (p50, p95, p99)        │   ┃
┃                                    ┃  │   sources: [chunk_042, ...],   │  ┃  │ • Peak Memory Usage (MB)                    │   ┃
┃                                    ┃  │   confidence: "HIGH",           │  ┃  │ • Throughput (QPS)                          │   ┃
┃                                    ┃  │   fallback_used: false          │  ┃  │                                             │   ┃
┃                                    ┃  │ }                               │  ┃  │ Answer Quality:                             │   ┃
┃                                    ┃  └──────────────┬──────────────────┘  ┃  │ • LLM-as-a-Judge Score (1-5)                │   ┃
┃                                    ┃                 │                     ┃  │   - Groundedness                            │   ┃
┃                                    ┃                 └─────────────────────╋──│   - Accuracy                                │   ┃
┃                                    ┃                       evaluated by    ┃  │   - Completeness                            │   ┃
┃                                    ┃                                       ┃  │ • Source Attribution Rate                   │   ┃
┃                                    ┃                                       ┃  │ • Hallucination Rate                        │   ┃
┃                                    ┃                                       ┃  └─────────────────────────────────────────────┘   ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃  LEGEND                                                                                                                         ┃
┃  ═══════                                                                                                                        ┃
┃  🔵 System Pipeline: Deployed on edge device (8GB RAM, Jetson Orin Nano)                                                        ┃
┃  🟠 Evaluation Protocol: Research methodology (offline analysis)                                                                ┃
┃  ───► Data Flow    ══► Index Load (mmap)    ─ ─ ► Evaluation Input                                                              ┃
┃                                                                                                                                 ┃
┃  Models: Generator=gemini-2.5-flash | Judge=claude-sonnet-4-5 | LLM=Qwen3-0.6B Q4_K_M | Embed=MiniLM/Qwen3-Emb                  ┃
┃  Edge Target (validated): 8GB RAM | Q4_K_M (~400MB) | p95 < 300ms                                                               ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

**System Pipeline (7단계)**:

| 단계 | 구성요소 | 설명 |
|------|---------|------|
| ① | Data Collection | Web Crawl (Wikipedia, Britannica), 농촌진흥청 PDF, 스마트팜코리아 가이드, EN/KO Bilingual |
| ② | Preprocessing | OCR (EasyOCR), Sentence-window chunking, Metadata tagging (crop, causal, numeric), **EN→KO Translation (gemini-2.5-flash)** |
| ③ | Knowledge Store | dense.faiss (mmap), sparse.pkl (TF-IDF), Causal Graph (in-memory), ontology.json (6 types) |
| ④ | Query Analysis | 온톨로지 매칭, **Dynamic Alpha (수치→α_s+0.2, 환경/영양→α_s+0.1, 병해/재배→α_p~0.3-0.4)** |
| ⑤ | HybridDAT Retrieval | 3채널 하이브리드 검색 (Dense FAISS + Sparse TF-IDF + PathRAG BFS 2-hop) + Score Fusion |
| ⑥ | Context Shaping | Crop Filter (+0.5/×0.15), Semantic Dedup (θ=0.85), Memory-aware Reranking |
| ⑦ | LLM Generation | Qwen3-0.6B Q4_K_M, Fallback Chain (Exact Cache→Similar Cache→Template→Search-only) |

**Evaluation Protocol (dataset-pipeline 기반)**:

| 구성요소 | 방법론 | 설명 |
|---------|-------|------|
| Dataset Generation | Self-Instruct (Wang, ACL23) | Seed questions에서 다양한 질문 자동 생성 |
| | Evol-Instruct (Xu, ICLR23) | 복잡도 점진적 진화 (basic→intermediate→advanced) |
| | RAFT (Zhang, COLM24) | Context-grounded answer generation |
| | LLM-as-a-Judge (Zheng, NeurIPS24) + Prometheus | 다차원 품질 평가 (Groundedness, Accuracy, Completeness) |
| QA Dataset | 220 pairs | 6 categories, ROUGE-L diversity 0.93, Groundedness 0.52 |
| Evaluation Metrics | Retrieval Quality | Recall@k, Precision@k, MRR |
| | Edge Performance | Latency (p50/p95/p99), Memory Usage, Throughput (QPS) |
| | Answer Quality | LLM-as-a-Judge Score (1-5), Hallucination Rate |

**핵심 설계 원칙:**

1. **오프라인 사전 구축**: 인덱싱/인과관계 그래프(in-memory 빌드)는 1회 오프라인으로 수행하여 런타임 부하 최소화
2. **메모리 효율**: mmap 기반 lazy loading으로 전체 인덱스를 RAM에 올리지 않음
3. **도메인 특화**: 온톨로지 + Dynamic Alpha 휴리스틱으로 범용 RAG 대비 검색 품질 향상
4. **데이터셋 생성**: 검증된 연구 방법론 (Self-Instruct, Evol-Instruct, RAFT, LLM-as-a-Judge) 적용
5. **검증 분리**: Groundedness Checks + Prompt Constraints는 Evaluation Protocol로 분리하여 학술적 규약 준수

> **Note**: Evaluation Protocol (Dataset Generation, Verification, Ablation, Benchmark)은 시스템 구성요소가 아닌 **연구 방법론**으로, Section 5 (Experiments)에서 상세히 다룬다. Dataset은 **dataset-pipeline** 프로젝트로 생성되었으며, Benchmark는 **내부 베이스라인(Dense-only, Sparse-only, Naive Hybrid)**과 비교한다.

### 3.1.2 시스템 아키텍처 (6계층 스택)

본 시스템은 스마트팜 도메인에 특화된 온디바이스 하이브리드 RAG로, 6계층 스택 아키텍처로 구성된다.

### 3.1.3 리소스 제약 및 설계 목표

엣지 환경의 리소스 제약을 명확히 정의하고, 이를 기반으로 각 컴포넌트를 설계하였다.

| 리소스 항목 | 최소 사양 | 권장 사양 | 설계 근거 |
|------------|----------|----------|----------|
| **RAM** | 8GB | 16GB | Jetson Orin Nano 타겟 |
| **저장공간** | 10GB | 20GB | GGUF 모델 + FAISS 인덱스 |
| **목표 지연** | p95 < 500ms | p95 < 300ms | 실시간 현장 응답 |
| **LLM 메모리** | ~2.5GB | ~4GB | Q4_K_M 양자화 기준 |
| **처리량** | 3 QPS | 8 QPS | CPU 단독 환경 |

### 3.1.4 6계층 아키텍처 (Figure 2)

> **Figure 2: 6-Layer Stack Architecture (권장 레이어드 아키텍처 템플릿)**

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Layer 5. Application & Policy                                       ┃
┃ ┌────────────────┐ ┌─────────────────┐ ┌─────────────────────────┐   ┃
┃ │ Streamlit UI   │ │ FastAPI REST    │ │ Offline Fallback Policy │   ┃
┃ │                │ │ /query /ingest  │ │ Cache → Template → Raw  │   ┃
┃ └────────────────┘ └─────────────────┘ └─────────────────────────┘   ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ Layer 4. Generation & Grounding                                      ┃
┃ ┌────────────────────────┐ ┌────────────────────────────────────┐   ┃
┃ │ Prompt Template        │ │ TemplateResponder (Fallback)       │   ┃
┃ │ build_rag_answer_prompt│ │ Ontology-based structured response │   ┃
┃ └────────────────────────┘ └────────────────────────────────────┘   ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ Layer 3. Context Shaping (토큰 절감 - 논문 핵심 기여)                ┃
┃ ┌──────────────┐ ┌────────────────┐ ┌────────────────────────────┐  ┃
┃ │ Crop Filter  │ │ Semantic Dedup │ │ Memory-aware Reranking     │  ┃
┃ │ +0.5/×0.15   │ │ θ=0.85         │ │ BGE/LLM-lite/none by RAM   │  ┃
┃ └──────────────┘ └────────────────┘ └────────────────────────────┘  ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ Layer 2. Retrieval Core (3채널 융합 검색)                            ┃
┃ ┌──────────────────────────────────────────────────────────────────┐┃
┃ │           HybridDATRetriever (Dynamic Alpha Tuning)              │┃
┃ │  ┌────────────┐  ┌─────────────┐  ┌────────────────────────────┐ │┃
┃ │  │   Dense    │  │   Sparse    │  │   PathRAG-lite             │ │┃
┃ │  │  (FAISS)   │  │  (TF-IDF)   │  │  (Causal Graph BFS 2-hop)  │ │┃
┃ │  │   α_d      │  │   α_s       │  │   α_p                      │ │┃
┃ │  └────────────┘  └─────────────┘  └────────────────────────────┘ │┃
┃ │         │               │                    │                   │┃
┃ │         └───────────────┼────────────────────┘                   │┃
┃ │                         ▼                                        │┃
┃ │                  Score Normalization & Fusion                    │┃
┃ └──────────────────────────────────────────────────────────────────┘┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ Layer 1. On-device Knowledge Store                                   ┃
┃ ┌────────────────────────────────────────────────────────────────┐  ┃
┃ │                    SmartFarm Knowledge Base                     │  ┃
┃ │  ┌────────────┐  ┌─────────────┐  ┌───────────────────────────┐│  ┃
┃ │  │ Dense Index│  │Sparse Index │  │ Causal Graph              ││  ┃
┃ │  │ dense.faiss│  │ sparse.pkl  │  │ (causes, solved_by edges) ││  ┃
┃ │  │ (mmap)     │  │             │  │                           ││  ┃
┃ │  └────────────┘  └─────────────┘  └───────────────────────────┘│  ┃
┃ │                                                                 │  ┃
┃ │  ┌─────────────────────────────────────────────────────────────┐│  ┃
┃ │  │ Domain Ontology (6 types)                                   ││  ┃
┃ │  │ crop | env | nutrient | disease | stage | practice         ││  ┃
┃ │  └─────────────────────────────────────────────────────────────┘│  ┃
┃ └────────────────────────────────────────────────────────────────┘  ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ Layer 0. Device & Runtime (제약/가속기)                              ┃
┃ ┌────────────────────────────────────────────────────────────────┐  ┃
┃ │     Hardware: CPU/GPU (Jetson Orin) | 8GB RAM | 10GB Storage   │  ┃
┃ ├────────────────────────────────────────────────────────────────┤  ┃
┃ │  ┌─────────────────┐  ┌───────────────┐  ┌──────────────────┐  │  ┃
┃ │  │ LLM: llama.cpp  │  │ Embedding:    │  │ VectorDB: FAISS  │  │  ┃
┃ │  │ Qwen3-0.6B      │  │ MiniLM (90MB) │  │ mmap enabled     │  │  ┃
┃ │  │ Q4_K_M (~400MB) │  │ or Qwen3-Emb  │  │                  │  │  ┃
┃ │  └─────────────────┘  └───────────────┘  └──────────────────┘  │  ┃
┃ └────────────────────────────────────────────────────────────────┘  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

**계층별 핵심 역할**:

| 계층 | 역할 | 핵심 컴포넌트 |
|------|------|--------------|
| **L5** | 사용자 인터페이스 및 정책 | FastAPI, Streamlit, 폴백 정책 |
| **L4** | 응답 생성 및 그라운딩 | 프롬프트 템플릿, 템플릿 응답기 |
| **L3** | 컨텍스트 압축 (논문 핵심) | 작물 필터, 중복 제거, 리랭킹 |
| **L2** | 3채널 하이브리드 검색 | Dense, Sparse, PathRAG 융합 |
| **L1** | 온디바이스 지식 저장소 | FAISS 인덱스, 인과관계 그래프, 온톨로지 |
| **L0** | 디바이스 런타임 | llama.cpp, 임베딩 모델, FAISS |

---

## 3.2 데이터 수집 및 전처리 파이프라인

### 3.2.1 데이터 수집

본 연구의 지식 베이스는 다음 세 가지 유형의 농업 문서로 구성된다.

| 데이터 유형 | 출처 | 형식 | 수량 |
|------------|------|------|------|
| **재배 매뉴얼** | 농촌진흥청, 도농업기술원 | PDF, 이미지 | ~50개 |
| **기술 가이드** | 스마트팜 코리아, 농업기술실용화재단 | 웹 문서, PDF | ~30개 |
| **작업 기록** | 현장 농가 메모, Q&A 게시판 | 텍스트, 이미지 | ~20개 |

**수집 기준:**
- 와사비 재배에 직접 관련된 문서 우선
- 환경 관리(온도, 습도, EC, pH)에 대한 수치 정보 포함 문서
- 병해충 진단 및 해결책이 명시된 문서

### 3.2.2 전처리 파이프라인 (Figure 3)

> **Figure 3: Data Preprocessing Pipeline**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           DATA PREPROCESSING PIPELINE                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                           입력 문서 (Input)                               │  │
│  │  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────┐                │  │
│  │  │ PDF 문서    │  │ 이미지 (스캔)   │  │ 텍스트 파일     │                │  │
│  │  │ 농촌진흥청  │  │ 현장 사진       │  │ Q&A 게시판     │                │  │
│  │  └──────┬──────┘  └────────┬────────┘  └────────┬────────┘                │  │
│  └─────────┼──────────────────┼───────────────────┼──────────────────────────┘  │
│            │                  │                   │                             │
│            ▼                  ▼                   │                             │
│  ┌───────────────────────────────────────────────┐│                             │
│  │              OCR 처리 (EasyOCR)               ││                             │
│  │  ┌────────────────────────────────────────┐   ││                             │
│  │  │ • 이미지 → 텍스트 변환                 │   ││                             │
│  │  │ • 테이블 구조 인식                     │   ││                             │
│  │  │ • 수치/단위 정규화:                    │   ││                             │
│  │  │   "25도" → 25℃                        │   ││                             │
│  │  │   "EC 2.5" → EC 2.5 dS/m              │   ││                             │
│  │  └────────────────────────────────────────┘   ││                             │
│  └─────────────────────┬─────────────────────────┘│                             │
│                        │                          │                             │
│                        ▼                          ▼                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │                    시맨틱 청킹 (Semantic Chunking)                          ││
│  │  ┌──────────────────┐  ┌───────────────────┐  ┌───────────────────┐         ││
│  │  │ 섹션 기반 분할   │  │ 의미 단위 병합    │  │ 오버랩 적용       │         ││
│  │  │ (제목, 소제목)   │→│ (200-500 토큰)    │→│ (50 토큰)         │         ││
│  │  │                  │  │                   │  │                   │         ││
│  │  └──────────────────┘  └───────────────────┘  └───────────────────┘         ││
│  └─────────────────────────────────┬───────────────────────────────────────────┘│
│                                    │                                            │
│                                    ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │                         메타데이터 추출 (Metadata)                          ││
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌─────────────┐   ││
│  │  │ 작물 태깅     │  │ 카테고리 분류 │  │ 인과관계 역할 │  │ 수치 정보   │   ││
│  │  │ 와사비, 토마토│  │ 재배기술      │  │ cause/effect  │  │ 온도, EC    │   ││
│  │  │ 딸기, 파프리카│  │ 환경관리      │  │ solution      │  │ pH, 습도    │   ││
│  │  │               │  │ 병해충, 영양  │  │               │  │             │   ││
│  │  └───────────────┘  └───────────────┘  └───────────────┘  └─────────────┘   ││
│  └─────────────────────────────────┬───────────────────────────────────────────┘│
│                                    │                                            │
│                                    ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │                              출력 (Output)                                  ││
│  │            청크 + 메타데이터 → Knowledge Store (인덱싱 단계로)               ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2.3 OCR 및 텍스트 정규화

이미지 기반 문서(스캔 PDF, 현장 사진)는 **EasyOCR**을 사용하여 텍스트로 변환한다.

**정규화 규칙:**
- 온도: "25도", "25°C", "섭씨 25도" → `25℃`
- EC: "2.5 dS/m", "EC 2.5", "전기전도도 2.5" → `EC 2.5 dS/m`
- pH: "pH6.5", "산도 6.5" → `pH 6.5`

```python
# 수치 정규화 예시
NORMALIZATION_PATTERNS = {
    r'(\d+\.?\d*)\s*(도|°C|℃|섭씨)': r'\1℃',
    r'(EC|전기전도도)\s*(\d+\.?\d*)': r'EC \2 dS/m',
    r'(pH|산도)\s*(\d+\.?\d*)': r'pH \2',
}
```

### 3.2.4 시맨틱 청킹 전략

단순 길이 기반 분할 대신, 문서의 **의미 구조**를 보존하는 청킹을 적용한다.

| 전략 | 설명 | 토큰 범위 |
|------|------|----------|
| **섹션 기반** | 제목/소제목으로 1차 분할 | 가변 |
| **의미 병합** | 짧은 섹션은 연관 섹션과 병합 | 200-500 |
| **오버랩** | 문맥 연속성을 위한 중복 구간 | 50 |

**청킹 파라미터:**
- `CHUNK_MIN_TOKENS`: 200 (너무 짧은 청크 방지)
- `CHUNK_MAX_TOKENS`: 500 (컨텍스트 윈도우 효율)
- `CHUNK_OVERLAP`: 50 (문맥 연속성)

### 3.2.5 메타데이터 자동 추출

각 청크에 대해 다음 메타데이터를 규칙 기반으로 자동 추출한다.

| 메타데이터 | 추출 방법 | 용도 |
|-----------|----------|------|
| **crop** | 온톨로지 매칭 (작물명 사전) | 작물 필터링 |
| **category** | 키워드 분류기 | 도메인 분석 |
| **causal_role** | 패턴 매칭 (원인/결과/해결 키워드) | PathRAG 그래프 |
| **numeric_info** | 정규표현식 추출 | Sparse 검색 강화 |
| **source** | 원본 파일명 + 페이지 | 근거 추적 |

```python
# 메타데이터 추출 예시
def extract_metadata(chunk_text: str) -> dict:
    return {
        "crop": ontology_matcher.match_crop(chunk_text),
        "category": classify_category(chunk_text),
        "causal_role": detect_causal_role(chunk_text),
        "numeric_info": extract_numeric_values(chunk_text),
        "source": {"file": source_file, "page": page_num}
    }
```

---

## 3.3 스마트팜 온톨로지

### 3.3.1 설계 배경

온톨로지 설계는 Stanford 온톨로지 구축 방법론[13]과 기존 농업 온톨로지 연구[9,10,11]를 참조하여 스마트팜 도메인에 적합한 6개 개념 유형을 정의하였다. CropDP-KG[12]의 엔티티 구조와 AgriKG[21]의 농업 엔티티 분류를 참고하여 한국 스마트팜 환경에 맞게 구성하였다.

### 3.3.2 개념 유형 정의 (Figure 4)

> **Figure 4: SmartFarm Domain Ontology (6 Concept Types)**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        SmartFarm Domain Ontology (6 Types)                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │
│  │   CROP (작물)   │  │   ENV (환경)    │  │ NUTRIENT (영양) │                  │
│  │ ───────────────│  │ ───────────────│  │ ───────────────│                  │
│  │ • 와사비       │  │ • 온도 (℃)     │  │ • 양액         │                  │
│  │ • 토마토       │  │ • 습도 (RH, %) │  │ • 비료         │                  │
│  │ • 파프리카     │  │ • EC (dS/m)    │  │ • 관수         │                  │
│  │ • 딸기         │  │ • pH (산도)    │  │                │                  │
│  │ • 상추         │  │ • CO2 (ppm)    │  │                │                  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │
│  │ DISEASE (병해)  │  │  STAGE (생육)   │  │PRACTICE (재배)  │                  │
│  │ ───────────────│  │ ───────────────│  │ ───────────────│                  │
│  │ • 흰가루병     │  │ • 육묘         │  │ • 차광         │                  │
│  │ • 뿌리썩음병   │  │ • 정식         │  │ • 환기         │                  │
│  │ • 연부병       │  │ • 생육         │  │ • 난방         │                  │
│  │ • 잿빛곰팡이   │  │ • 수확         │  │ • 냉각         │                  │
│  │               │  │                │  │ • 살균         │                  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │
│                                                                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Usage Example:                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │  Query: "와사비 고온 관리"                                               │   │
│  │       │                                                                  │   │
│  │       ▼                                                                  │   │
│  │  OntologyMatcher.match()                                                 │   │
│  │       │                                                                  │   │
│  │       ▼                                                                  │   │
│  │  hits = { crop: ["와사비"], env: ["온도"] }                              │   │
│  │       │                                                                  │   │
│  │       ▼                                                                  │   │
│  │  Dynamic Alpha: 환경 관련 → α_s + 0.1 (Sparse 강화)                      │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

| 유형 | 설명 | 예시 | 근거 |
|------|------|------|------|
| **crop** | 재배 작물 | 와사비, 토마토, 딸기 | CropDP-KG의 Crops Name 엔티티[12] |
| **env** | 환경 요소 | 온도, 습도, EC, pH, CO2 | 스마트팜 IoT 센서 데이터 표준[11] |
| **nutrient** | 영양소 | 양액, 비료, 관수 | 농업 지식 베이스[9] |
| **disease** | 병해충 | 흰가루병, 뿌리썩음병, 연부병 | CropDP-KG의 Disease/Pest 분류[12,13] |
| **stage** | 생육 단계 | 육묘, 정식, 생육, 수확 | 작물 생육 모델[17] |
| **practice** | 재배 실천 | 차광, 환기, 난방, 살균 | 농업 실천 온톨로지[9,10] |

각 개념은 동의어/유의어 목록(alias)을 포함한다. 예를 들어 "와사비"의 alias에는 "산와사비", "본와사비"가 포함되어 사용자가 어떤 표현을 쓰더라도 동일 개념으로 인식한다.

---

## 3.4 3채널 하이브리드 검색 (HybridDAT)

### 3.4.1 설계 근거

Dense retrieval은 의미적 유사성 검색에 강하지만 "EC 2.5 dS/m" 같은 수치 정보 매칭에 취약하다. Sparse retrieval은 정확한 키워드 매칭에 강하지만 의미적 유사성을 놓칠 수 있다[5]. 본 시스템은 Dense-Sparse-PathRAG 3채널 융합과 질의 특성에 따른 동적 가중치 조정(Dynamic Alpha Tuning)을 적용한다.

### 3.4.2 HybridDATRetriever 플로우 (Figure 5)

> **Figure 5: HybridDAT Retrieval Flow (3채널 융합 검색)**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          HybridDATRetriever Flow                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  Query: "와사비 적정 온도는?"                                             │  │
│  └───────────────────────────────────┬───────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  1. 온톨로지 매칭                                                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  OntologyMatcher.match()                                            │  │  │
│  │  │  → hits = { crop: ["와사비"], env: ["온도"] }                        │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────┬───────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  2. Dynamic Alpha 계산                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                     ┌────────────────────┐                          │  │  │
│  │  │                     │  수치/단위 포함?   │                          │  │  │
│  │  │                     └─────────┬──────────┘                          │  │  │
│  │  │                ┌──────────────┼──────────────┐                      │  │  │
│  │  │                │ Yes          │ No           │                      │  │  │
│  │  │                ▼              ▼              │                      │  │  │
│  │  │  ┌────────────────┐  ┌────────────────────┐ │                      │  │  │
│  │  │  │ 수치 질의      │  │  병해/재배 관련?   │ │                      │  │  │
│  │  │  │ α_d=0.3        │  └─────────┬──────────┘ │                      │  │  │
│  │  │  │ α_s=0.7        │       ┌────┼────┐       │                      │  │  │
│  │  │  │ α_p=0.0        │       │ Yes│ No │       │                      │  │  │
│  │  │  └────────────────┘       ▼    ▼    │       │                      │  │  │
│  │  │          ┌────────────────┐  ┌────────────────┐                    │  │  │
│  │  │          │ 병해/재배 질의 │  │ 일반 질의      │                    │  │  │
│  │  │          │ α_d=0.35       │  │ α_d=0.5        │                    │  │  │
│  │  │          │ α_s=0.35       │  │ α_s=0.5        │                    │  │  │
│  │  │          │ α_p=0.3        │  │ α_p=0.0        │                    │  │  │
│  │  │          └────────────────┘  └────────────────┘                    │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────┬───────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  3. 3채널 병렬 검색                                                       │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         │  │
│  │  │   Dense Channel  │  │  Sparse Channel  │  │ PathRAG Channel  │         │  │
│  │  │ ────────────────│  │ ────────────────│  │ ────────────────│         │  │
│  │  │ EmbeddingRetriever│  │ MiniStore        │  │ SmartFarmGraph   │         │  │
│  │  │ FAISS IndexFlatIP│  │ TfidfVectorizer  │  │ BFS 2-hop        │         │  │
│  │  │ cosine similarity│  │ keyword matching │  │ causal edges     │         │  │
│  │  │        α_d       │  │       α_s        │  │       α_p        │         │  │
│  │  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘         │  │
│  │           └─────────────────────┼─────────────────────┘                   │  │
│  │                                 │                                         │  │
│  └─────────────────────────────────┼─────────────────────────────────────────┘  │
│                                    │                                            │
│                                    ▼                                            │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  4. Score Fusion                                                          │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  • Min-Max 정규화 (각 채널 스코어 0-1 변환)                         │  │  │
│  │  │  • final = α_d × dense + α_s × sparse + α_p × path                  │  │  │
│  │  │  • 스코어 순 정렬 → Top-k × 2 (8개) 후보 선정                       │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────┬───────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  Output: Top-k × 2 후보 → Context Shaping으로                             │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.4.3 동적 가중치 규칙 (Dynamic Alpha)

질의 내용을 분석하여 가중치를 자동 결정한다:

| 질의 특성 | Dense (α_d) | Sparse (α_s) | PathRAG (α_p) | 설계 근거 |
|----------|-------------|--------------|---------------|----------|
| 일반 질의 | 0.5 | 0.5 | 0.0 | 의미 검색과 키워드 매칭 균형 |
| 수치/단위 포함 ("EC 2.5", "25℃") | 0.3 | 0.7 | 0.0 | 수치는 정확히 일치해야 함[4] |
| 병해/재배 관련 ("흰가루병 원인") | 0.35 | 0.35 | 0.3 | 인과관계 탐색 활성화 |

---

## 3.5 인과관계 그래프 (PathRAG-lite)

### 3.5.1 설계 배경

농업 도메인에서 "고수온 → 연부병 발생 → 수온 관리" 같은 인과 체인이 핵심 정보 구조를 형성한다[17]. GraphRAG[7]는 LLM으로 개체와 관계를 추출하므로 구축 비용이 높다(문서 1000개당 GPT-4 $100+). 본 시스템은 규칙 기반 패턴 매칭으로 인과관계 그래프를 구축하여 비용을 $0으로 절감한다.

### 3.5.2 인과관계 역할 분류

텍스트 패턴 매칭으로 문서의 역할을 분류한다:

| 역할 | 판별 패턴 | 예시 문장 |
|------|----------|----------|
| **Cause** | "원인", "때문", "~하면", "높으면", "낮으면" | "고온 환경에서는 화분 활력이 저하된다" |
| **Effect** | "결과", "증상", "문제", "장애", "저하" | "착과율이 떨어지는 문제가 발생한다" |
| **Solution** | "관리", "해야", "방법", "조치", "예방" | "야간 온도를 18℃ 이하로 관리해야 한다" |

### 3.5.3 PathRAG-lite BFS 탐색 (Figure 6)

PathRAG[8]의 경로 탐색 개념을 차용한 경량 구현이다. BFS(너비 우선 탐색) 기반 2-hop 탐색으로 원인→결과→해결책 문서를 수집한다.

> **Figure 6: PathRAG-lite BFS 2-hop Traversal**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       PathRAG-lite BFS 2-hop Traversal                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  Query: "와사비 고온 피해 해결 방법"                                      │  │
│  │  온톨로지 매칭: { crop: ["와사비"], env: ["고온"] }                       │  │
│  └───────────────────────────────────┬───────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                      SmartFarm Knowledge Graph                             │  │
│  │                                                                           │  │
│  │  ┌─────────────────────────── Concept Nodes ────────────────────────────┐ │  │
│  │  │                                                                       │ │  │
│  │  │    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │ │  │
│  │  │    │ crop:와사비  │    │  env:온도    │    │disease:연부병│          │ │  │
│  │  │    └──────┬───────┘    └──────┬───────┘    └──────┬───────┘          │ │  │
│  │  │           │                   │                   │                  │ │  │
│  │  └───────────┼───────────────────┼───────────────────┼──────────────────┘ │  │
│  │              │                   │                   │                    │  │
│  │              │ recommended_for   │ mentions          │ associated_with    │  │
│  │              │                   │                   │                    │  │
│  │  ┌───────────┼───────────────────┼───────────────────┼──────────────────┐ │  │
│  │  │           ▼                   ▼                   ▼                  │ │  │
│  │  │  ┌─────────────────────────────────────────────────────────────────┐ │ │  │
│  │  │  │                    Practice Nodes (Documents)                    │ │ │  │
│  │  │  │                                                                 │ │ │  │
│  │  │  │  ┌─────────────────┐       ┌─────────────────┐                  │ │ │  │
│  │  │  │  │ chunk_001       │       │ chunk_002       │                  │ │ │  │
│  │  │  │  │ "고온 시 잎..."  │──────►│ "생육 저하..."   │                  │ │ │  │
│  │  │  │  │ role: CAUSE     │causes │ role: EFFECT    │                  │ │ │  │
│  │  │  │  └─────────────────┘       └────────┬────────┘                  │ │ │  │
│  │  │  │                                     │                           │ │ │  │
│  │  │  │                              solved_by (2개)                    │ │ │  │
│  │  │  │                        ┌────────────┴────────────┐              │ │ │  │
│  │  │  │                        ▼                         ▼              │ │ │  │
│  │  │  │               ┌─────────────────┐       ┌─────────────────┐     │ │ │  │
│  │  │  │               │ chunk_003       │       │ chunk_004       │     │ │ │  │
│  │  │  │               │ "차광망 설치..." │       │ "수온 18℃..."   │     │ │ │  │
│  │  │  │               │ role: SOLUTION  │       │ role: SOLUTION  │     │ │ │  │
│  │  │  │               └─────────────────┘       └─────────────────┘     │ │ │  │
│  │  │  └─────────────────────────────────────────────────────────────────┘ │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         BFS 2-hop 탐색 과정                               │  │
│  │  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐     │  │
│  │  │    Hop 0         │    │    Hop 1         │    │    Hop 2         │     │  │
│  │  │ ────────────────│───►│ ────────────────│───►│ ────────────────│     │  │
│  │  │ 시작점:          │    │ 연결 문서:       │    │ 인과관계 따라:   │     │  │
│  │  │ crop:와사비      │    │ chunk_001        │    │ chunk_003        │     │  │
│  │  │ env:온도         │    │ chunk_002        │    │ chunk_004        │     │  │
│  │  └──────────────────┘    └──────────────────┘    └──────────────────┘     │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  검색 결과: chunk_003, chunk_004 (Solutions) → HybridDAT 스코어에 반영    │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.5.4 그래프 스키마

CropDP-KG[12]와 AgriKG[21]의 스키마 설계를 참조하여 구성하였다.

**노드 타입**: practice(문서), crop, env, disease, nutrient, stage

**엣지 타입**:

| 타입 | 의미 | 참조 |
|------|------|------|
| recommended_for | 작물 → 실천 | AgriKG[21] |
| associated_with | 병해 → 실천 | CropDP-KG[12] |
| mentions | 실천 → 개념 | 농업 온톨로지[10] |
| **causes** | 실천 → 실천 | 인과 추출[14,15] |
| **solved_by** | 실천 → 실천 | 인과 추출[14,15] |

---

## 3.6 Context Shaping (컨텍스트 압축)

엣지 LLM은 토큰이 곧 지연/전력 비용이므로, 검색 결과를 그대로 전달하지 않고 압축/필터링하는 것이 핵심이다.

### 3.6.1 Context Shaping 파이프라인 (Figure 7)

> **Figure 7: Context Shaping Pipeline (토큰 절감 - 논문 핵심 기여)**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Context Shaping Pipeline                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌───────────┐ │
│  │   INPUT     │    │   CROP FILTER   │    │ SEMANTIC DEDUP  │    │  OUTPUT   │ │
│  │ ─────────  │    │ ─────────────  │    │ ─────────────  │    │ ─────────│ │
│  │             │    │                 │    │                 │    │           │ │
│  │  검색 결과  │───►│  작물 필터링    │───►│  중복 제거      │───►│ 최종 Top-k│ │
│  │  16 docs    │    │  ~12 docs       │    │  ~8 docs        │    │ 4 docs    │ │
│  │             │    │                 │    │                 │    │           │ │
│  └─────────────┘    └─────────────────┘    └─────────────────┘    └───────────┘ │
│                              │                      │                           │
│                              ▼                      ▼                           │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                           │  │
│  │  ┌─────────────────────────────────┐  ┌─────────────────────────────────┐ │  │
│  │  │       Crop Filter Logic         │  │    Semantic Deduplication       │ │  │
│  │  │ ─────────────────────────────  │  │ ─────────────────────────────  │ │  │
│  │  │                                 │  │                                 │ │  │
│  │  │  질의 작물 추출: "와사비"       │  │  임베딩 계산: emb = encode(doc) │ │  │
│  │  │            │                    │  │            │                    │ │  │
│  │  │            ▼                    │  │            ▼                    │ │  │
│  │  │    ┌────────────────┐           │  │  유사도 행렬: sim = emb @ emb.T │ │  │
│  │  │    │ 문서 작물 비교 │           │  │            │                    │ │  │
│  │  │    └───────┬────────┘           │  │            ▼                    │ │  │
│  │  │   ┌────────┼────────┐           │  │    ┌────────────────┐           │ │  │
│  │  │   │        │        │           │  │    │ sim ≥ 0.85 ?  │           │ │  │
│  │  │   ▼        ▼        ▼           │  │    └───────┬────────┘           │ │  │
│  │  │ ┌─────┐ ┌─────┐ ┌─────┐         │  │       ┌────┴────┐               │ │  │
│  │  │ │일치 │ │불일치│ │없음 │         │  │       │ Yes     │ No            │ │  │
│  │  │ │+0.5 │ │×0.15│ │유지 │         │  │       ▼         ▼               │ │  │
│  │  │ └─────┘ └─────┘ └─────┘         │  │  [후순위 제거]  [유지]           │ │  │
│  │  └─────────────────────────────────┘  └─────────────────────────────────┘ │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                     Memory-aware Reranking (Optional)                      │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐   │  │
│  │  │                       가용 RAM 체크                                 │   │  │
│  │  │  ┌──────────────┬──────────────────┬──────────────────────────┐    │   │  │
│  │  │  │  < 0.8GB     │   0.8GB - 1.5GB  │       ≥ 1.5GB            │    │   │  │
│  │  │  │     │        │        │         │          │               │    │   │  │
│  │  │  │     ▼        │        ▼         │          ▼               │    │   │  │
│  │  │  │  none (skip) │   LLM-lite       │   BGE Reranker           │    │   │  │
│  │  │  │  +0MB        │   ~0MB (재사용)   │   ~500MB                 │    │   │  │
│  │  │  └──────────────┴──────────────────┴──────────────────────────┘    │   │  │
│  │  └────────────────────────────────────────────────────────────────────┘   │  │
│  │                                    │                                       │  │
│  │                                    ▼                                       │  │
│  │                          Final Top-k (4 docs)                              │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.6.2 작물 필터링 (Crop-aware Filtering)

농업 지식 그래프 연구[4,12]에서 작물별 맥락 의존성이 강조되었다. 질의의 작물과 문서의 작물 메타데이터를 비교하여 스코어를 조정한다.

| 조건 | 스코어 조정 | 효과 |
|------|------------|------|
| 작물 일치 | +0.5 | 관련 문서 우선 |
| 작물 불일치 | ×0.15 | 무관한 작물 정보 억제 |
| 작물 정보 없음 | 유지 | 일반 정보 보존 |

### 3.6.3 시맨틱 중복 제거 (Semantic Deduplication)

MMR[18]과 VRSD[19]를 참조하여 검색 결과의 다양성을 확보한다. 두 문서의 임베딩 벡터 간 코사인 유사도가 임계값(θ=0.85) 이상인 문서 쌍에서 후순위 문서를 제거한다.

### 3.6.4 메모리 적응형 리랭킹

런타임 가용 메모리에 따라 리랭커를 동적으로 선택한다:

| 가용 RAM | 리랭커 | 추가 메모리 | 설명 |
|----------|--------|------------|------|
| < 0.8GB | none | 0MB | 리랭킹 비활성화 |
| 0.8GB ~ 1.5GB | LLM-lite | ~0MB | llama.cpp 재사용 |
| ≥ 1.5GB | BGE | ~500MB | BGE-reranker-v2-m3 |

---

## 3.7 엣지 배포 최적화

### 3.7.1 메모리 계층 구조 (RAM vs Flash)

엣지 환경에서 "벡터 인덱스가 RAM에 다 못 올라간다"는 병목을 해결하기 위해 계층적 메모리 구조를 설계하였다.

> **Memory Hierarchy (RAM vs Flash/SSD)**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Memory Hierarchy (8GB RAM Budget)                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        RAM (Hot Data) - 항상 메모리에 상주                 │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  ┌───────────┐  │  │
│  │  │ Query Cache │  │ Embedding   │  │ FAISS mmap active   │  │LLM Weights│  │  │
│  │  │ (LRU 128)   │  │ Cache (256) │  │ pages only          │  │ ~2.5GB    │  │  │
│  │  │ 검색 결과   │  │ 쿼리 임베딩 │  │ 자주 접근하는 벡터  │  │ Q4_K_M    │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  └───────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                      ↕                                          │
│                               mmap I/O (lazy load)                              │
│                                      ↕                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Flash/SSD (Cold Data) - 필요시 로드                     │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │ dense.faiss (mmap)  │  sparse.pkl  │  responses.jsonl │Causal Graph│  │  │
│  │  │ [전체 인덱스 파일]   │  [TF-IDF]    │  [캐시 영속화]   │[in-memory] │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  메모리 예산 (8GB RAM):                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  LLM: ~2.5GB  │  Embedding: ~90MB  │  FAISS Active: ~200MB  │  Caches: ~50MB│ │
│  │  Runtime: ~500MB  │  ★ 여유: ~4.6GB                                         │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.7.2 LLM 양자화 전략

llama.cpp의 GGUF 포맷[23]을 활용하여 Q4_K_M 양자화를 기본으로 적용한다.

| 양자화 수준 | 메모리 (4B 모델) | 품질 손실 | 적용 환경 |
|------------|-----------------|----------|----------|
| FP16 (원본) | ~8GB | 없음 | 서버 환경 (GPU 필수) |
| INT8 | ~4GB | 최소 | 고사양 엣지 (8GB RAM) |
| **Q4_K_M** | ~2.5GB | 낮음 | **일반 엣지 (권장)** |
| Q2_K | ~1.5GB | 중간 | 극저사양 환경 |

Q4_K_M은 중요한 레이어는 5비트, 나머지는 4비트로 혼합 양자화하여 품질 대비 메모리 효율의 최적점으로 평가된다.

### 3.7.3 오프라인 폴백 모드 (Figure 8)

네트워크 단절 또는 LLM 장애 시 다음과 같은 폴백 전략을 적용한다:

> **Figure 8: Offline Fallback Chain**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Offline Fallback Chain                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         Query Processing                                   │  │
│  └───────────────────────────────────┬───────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│                            ┌─────────────────┐                                  │
│                            │ 0. Exact Cache  │ ◀── ResponseCache.get(query)     │
│                            │    Lookup       │     (정확 매칭)                   │
│                            └────────┬────────┘                                  │
│                                     │ miss                                      │
│                                     ▼                                           │
│                            ┌─────────────────┐                                  │
│                            │ Hybrid Retrieval│ ◀── Dense + Sparse + PathRAG     │
│                            │ + Query Cache   │     (SimpleQueryCache)           │
│                            └────────┬────────┘                                  │
│                                     │                                           │
│                                     ▼                                           │
│                      ┌──────────────────────────────┐                           │
│                      │      LLM Generation          │                           │
│                      │    (Qwen3-0.6B Q4_K_M)       │                           │
│                      └──────────────┬───────────────┘                           │
│                                     │                                           │
│                    ┌────────────────┼────────────────┐                          │
│                    │ success        │ failure        │                          │
│                    ▼                ▼                │                          │
│            ┌──────────────┐  ┌───────────────────────┴──────────────────────┐   │
│            │ Normal Answer│  │              Fallback Chain                  │   │
│            │ + Cache Save │  │                                              │   │
│            └──────────────┘  │  ┌─────────────────────────────────────────┐ │   │
│                              │  │ 1. Similar Cache                        │ │   │
│                              │  │ ─────────────────────────────────────── │ │   │
│                              │  │ ResponseCache.get_similar()             │ │   │
│                              │  │ 임베딩 유사도 ≥ 0.9                      │ │   │
│                              │  │ 이전 유사 질의 응답 재활용               │ │   │
│                              │  └──────────────────┬──────────────────────┘ │   │
│                              │                     │ miss                   │   │
│                              │                     ▼                        │   │
│                              │  ┌─────────────────────────────────────────┐ │   │
│                              │  │ 2. Template Response                    │ │   │
│                              │  │ ─────────────────────────────────────── │ │   │
│                              │  │ TemplateResponder.generate()            │ │   │
│                              │  │ 온톨로지 매칭 기반 정형화된 응답         │ │   │
│                              │  │ • crop_env: "와사비 온도 관련..."       │ │   │
│                              │  │ • crop_disease: "토마토 흰가루병..."    │ │   │
│                              │  │ • disease_solution: "연부병 해결..."    │ │   │
│                              │  └──────────────────┬──────────────────────┘ │   │
│                              │                     │ 매칭 실패              │   │
│                              │                     ▼                        │   │
│                              │  ┌─────────────────────────────────────────┐ │   │
│                              │  │ 3. Search Only                          │ │   │
│                              │  │ ─────────────────────────────────────── │ │   │
│                              │  │ LLM 없이 검색 결과만 반환               │ │   │
│                              │  │ 문서 목록 표시 (fallback_mode: true)    │ │   │
│                              │  └─────────────────────────────────────────┘ │   │
│                              └──────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

| 폴백 단계 | 동작 | 언제 사용 |
|----------|------|----------|
| **Similar Cache** | 이전 유사 질의 응답 재활용 | 반복/유사 질의 시 |
| **Template Response** | 온톨로지 기반 정형 응답 생성 | 간단한 조회 시 |
| **Search Only** | LLM 없이 검색 결과만 반환 | LLM 완전 불가 시 |

---

## 3.8 런타임 검증 및 신뢰도 표시

> **Note**: 본 섹션은 시스템에 내장된 **런타임 검증 기능**을 다룬다. Ablation Study, Benchmark 비교 등 **연구 방법론으로서의 평가**는 Section 5 (Experiments)에서 상세히 기술한다.

엣지 환경에서 LLM의 환각(hallucination) 위험을 완화하기 위해, 시스템은 응답 생성 시점에 다음과 같은 런타임 검증 메커니즘을 수행한다.

### 3.8.1 근거 추적 (Source Attribution)

생성된 응답의 각 주장에 대해 근거 문서를 명시적으로 연결한다.

> **Source Attribution Flow**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Source Attribution                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────────────────┐     ┌────────────────────┐     ┌────────────────────┐   │
│  │     LLM 응답       │     │     근거 문서       │     │     검증 출력       │   │
│  │ ────────────────  │     │ ────────────────  │     │ ────────────────  │   │
│  │                    │     │                    │     │                    │   │
│  │ 와사비의 적정 수온은│────►│ [chunk_042]        │────►│ ✓ 근거 있음        │   │
│  │ 13-17℃입니다.     │     │ 와사비재배 매뉴얼   │     │ similarity: 0.92   │   │
│  │                    │     │ p.15               │     │                    │   │
│  │                    │     │                    │     │                    │   │
│  │ 고온 시 연부병 위험 │────►│ [chunk_089]        │────►│ ✓ 근거 있음        │   │
│  │ 이 증가합니다.     │     │ 병해충 관리 가이드  │     │ similarity: 0.87   │   │
│  │                    │     │ p.8                │     │                    │   │
│  └────────────────────┘     └────────────────────┘     └────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**구현 방식:**
1. LLM 프롬프트에 검색된 문서와 함께 "근거를 명시하라"는 지시 포함
2. 응답 생성 후, 주장-문서 간 임베딩 유사도 계산
3. 유사도가 임계값(0.7) 미만인 주장에 대해 경고 표시

### 3.8.2 런타임 환각 감지 (Figure 9)

> **Figure 9: Runtime Hallucination Detection Pipeline**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     Runtime Hallucination Detection Pipeline                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                              입력 (Input)                                  │  │
│  │  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐  │  │
│  │  │      LLM 생성 응답          │  │        검색된 근거 문서              │  │  │
│  │  └──────────────┬──────────────┘  └──────────────┬──────────────────────┘  │  │
│  └─────────────────┼────────────────────────────────┼────────────────────────┘  │
│                    │                                │                           │
│                    └────────────────┬───────────────┘                           │
│                                     │                                           │
│                                     ▼                                           │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                           환각 감지 (Detection)                            │  │
│  │                                                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 1. Claim Extraction                                                 │  │  │
│  │  │    응답에서 사실적 주장 추출 (수치, 권장사항 등)                      │  │  │
│  │  └─────────────────────────────────┬───────────────────────────────────┘  │  │
│  │                                    │                                      │  │
│  │                                    ▼                                      │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 2. Evidence Matching                                                │  │  │
│  │  │    주장-문서 임베딩 유사도 계산 (threshold: 0.7)                     │  │  │
│  │  └─────────────────────────────────┬───────────────────────────────────┘  │  │
│  │                                    │                                      │  │
│  │                                    ▼                                      │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 3. Consistency Check                                                │  │  │
│  │  │    수치 정보 일치 확인 (범위, 단위 검증)                             │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────┬───────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         신뢰도 산출 (Scoring)                              │  │
│  │                                                                           │  │
│  │                    ┌─────────────────────────────┐                        │  │
│  │                    │   모든 주장에 근거 있음?    │                        │  │
│  │                    └──────────────┬──────────────┘                        │  │
│  │                    ┌──────────────┼──────────────┐                        │  │
│  │                    │ Yes          │ Partial      │ No                     │  │
│  │                    ▼              ▼              ▼                        │  │
│  │              ┌──────────┐  ┌──────────┐  ┌──────────┐                     │  │
│  │              │   HIGH   │  │  MEDIUM  │  │   LOW    │                     │  │
│  │              │ ✓ 신뢰   │  │ ⚠ 일부   │  │ ✗ 근거  │                     │  │
│  │              │ 가능     │  │ 미확인   │  │ 부족     │                     │  │
│  │              │ ≥80%     │  │ ≥60%     │  │ <60%     │                     │  │
│  │              └──────────┘  └──────────┘  └──────────┘                     │  │
│  └───────────────────────────────────┬───────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                              출력 (Output)                                 │  │
│  │              응답 + 신뢰도 표시 + 근거 문서 링크 + warnings                │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.8.3 수치 정보 검증

농업 도메인에서 수치 정보의 정확성은 특히 중요하다. 다음과 같은 규칙 기반 검증을 적용한다.

| 검증 항목 | 방법 | 예시 |
|----------|------|------|
| **범위 검증** | 도메인 지식 기반 허용 범위 | 수온 10-25℃, pH 5.5-7.5 |
| **일관성 검증** | 근거 문서 내 수치와 비교 | 응답 "18℃" vs 문서 "18℃" ✓ |
| **단위 검증** | 단위 변환 정확성 확인 | EC 2.5 dS/m ≠ 2500 µS/cm 표기 주의 |

### 3.8.4 신뢰도 표시 및 폴백

최종 응답에는 다음 정보가 함께 제공된다:

```json
{
  "answer": "와사비의 적정 수온은 13-17℃입니다...",
  "confidence": "HIGH",
  "sources": [
    {"chunk_id": "chunk_042", "title": "와사비재배 매뉴얼", "page": 15, "similarity": 0.92}
  ],
  "warnings": [],
  "fallback_used": false
}
```

**신뢰도 수준 정의:**

| 수준 | 조건 | 사용자 안내 |
|------|------|-----------|
| **HIGH** | 모든 주장에 유사도 ≥0.8 근거 존재 | 응답 신뢰 가능 |
| **MEDIUM** | 일부 주장만 근거 확인 (≥60%) | 추가 확인 권장 |
| **LOW** | 근거 확인 불가 (<60%) | 전문가 상담 권장 |

---

## 3.9 관련 연구와의 차별점

> **Note**: 관련 연구에 대한 포괄적인 리뷰는 Section 2 (Related Work)를 참조한다. 본 섹션에서는 제안 방법론의 **핵심 차별점**을 요약한다.

### 3.9.1 EdgeRAG vs ERA-SmartFarm-RAG

| 구분 | EdgeRAG[24] | ERA-SmartFarm-RAG |
|------|-------------|-------------------|
| **최적화 초점** | 범용 메모리 최적화 | 도메인 특화 + 엣지 배포 |
| **인덱싱 전략** | 온라인 계층적 인덱싱 | 오프라인 사전 인덱싱 + mmap |
| **검색 채널** | 단일 Dense | **Dense + Sparse + PathRAG** |
| **그래프 활용** | 없음 | **인과관계 그래프** |
| **도메인 지식** | 범용 | **농업 온톨로지 6개 유형** |
| **메모리 절감** | 계층적 로딩 50%↓ | **양자화 75%↓ + mmap** |
| **오프라인 지원** | 제한적 | **폴백 체인 (Cache→Template→Search)** |

### 3.9.2 MobileRAG 패턴 비교

| 구분 | MobileRAG (EcoVector+SCR) | ERA-SmartFarm-RAG |
|------|---------------------------|-------------------|
| **인덱스 파티셔닝** | k-means 클러스터 계층 | FAISS mmap (전체 인덱스) |
| **부분 로딩** | 클러스터별 on-demand | mmap lazy load (OS 페이지 캐시) |
| **토큰 절감** | SCR (Selective Content Reduction) | **Semantic Dedup + Crop Filter** |
| **런타임** | AI Edge / MLX | **llama.cpp GGUF** |

### 3.9.3 핵심 차별점

1. **도메인 특화**: 범용 메모리 최적화 대신 농업 온톨로지와 인과관계 그래프 활용
2. **3채널 검색**: 수치/단위 정보(EC, pH)의 정확한 매칭을 위한 Sparse 채널 유지
3. **경량 Context Shaping**: SCR 대신 Semantic Dedup + Crop Filter (구현 단순화)
4. **완전 오프라인**: Template Responder로 LLM 없이도 기본 응답 가능

---

## 참조

> 상세 아키텍처 다이어그램 (ASCII/DOT/Mermaid): [figures/ARCHITECTURE_FIGURE_DESIGN.md](figures/ARCHITECTURE_FIGURE_DESIGN.md)
> 
> 최신 연구 동향 및 기술 사양: [supplementary/architecture_details.md](supplementary/architecture_details.md)
