services:
  # ==============================================================================
  # E2E override: isolate all mutable paths under data/e2e_runs/${E2E_RUN_ID}/...
  #
  # Usage:
  #   E2E_RUN_ID=$(date -u +%Y%m%dT%H%M%SZ) \
  #   docker compose -f docker-compose.yml -f docker-compose.research.yml -f docker-compose.e2e.yml --profile e2e up -d
  #
  # Then run:
  #   docker compose -f docker-compose.yml -f docker-compose.research.yml -f docker-compose.e2e.yml --profile e2e run --rm e2e
  # ==============================================================================

  api:
    environment:
      E2E_RUN_ID: ${E2E_RUN_ID:-e2e_local}
      # Derived artifacts + caches (rebuildable)
      INDEX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index
      TRIGRAPH_INDEX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/trigraph_edge
      OVERLAY_ROOT_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/overlay_uploads
      BASE_BUNDLE_ROOT_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/base_bundles

      # Mutable runtime inputs
      UPLOADS_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/uploads
      KB_INBOX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/inbox/base_updates

      # SQLite SoT
      BASE_KB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/base.sqlite
      OVERLAY_KB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay.sqlite
      INGEST_DB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay.sqlite
      SENSOR_DB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay_sensors.sqlite

      # Exercise token chunking path
      CHUNK_METHOD: ${CHUNK_METHOD:-token}
      CHUNK_TOKEN_SIZE: ${CHUNK_TOKEN_SIZE:-512}
      CHUNK_TOKEN_OVERLAP: ${CHUNK_TOKEN_OVERLAP:-64}
      CHUNK_TOKENIZER_MODEL: ${CHUNK_TOKENIZER_MODEL:-gpt-4o-mini}

      # Exercise gleaning path
      KBUPDATE_MAX_GLEANINGS: ${KBUPDATE_MAX_GLEANINGS:-1}

      # Deterministic OCR in tests (tesseract is installed in the image)
      OCR_BACKEND: ${OCR_BACKEND:-tesseract}
      OCR_LANG: ${OCR_LANG:-english}

  ingest-worker:
    environment:
      E2E_RUN_ID: ${E2E_RUN_ID:-e2e_local}
      INDEX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index
      TRIGRAPH_INDEX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/trigraph_edge
      OVERLAY_ROOT_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/overlay_uploads
      BASE_BUNDLE_ROOT_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/base_bundles
      UPLOADS_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/uploads
      KB_INBOX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/inbox/base_updates
      BASE_KB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/base.sqlite
      OVERLAY_KB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay.sqlite
      INGEST_DB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay.sqlite
      SENSOR_DB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay_sensors.sqlite
      CHUNK_METHOD: ${CHUNK_METHOD:-token}
      CHUNK_TOKEN_SIZE: ${CHUNK_TOKEN_SIZE:-512}
      CHUNK_TOKEN_OVERLAP: ${CHUNK_TOKEN_OVERLAP:-64}
      CHUNK_TOKENIZER_MODEL: ${CHUNK_TOKENIZER_MODEL:-gpt-4o-mini}
      KBUPDATE_MAX_GLEANINGS: ${KBUPDATE_MAX_GLEANINGS:-1}
      OCR_BACKEND: ${OCR_BACKEND:-tesseract}
      OCR_LANG: ${OCR_LANG:-english}

  # Tri-Graph indexer should write into the same isolated index dir.
  indexer-v2:
    environment:
      E2E_RUN_ID: ${E2E_RUN_ID:-e2e_local}
      INDEX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index
      TRIGRAPH_INDEX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/trigraph_edge
      TRIGRAPH_INDEX_LIMIT: ${TRIGRAPH_INDEX_LIMIT:-80}

  # E2E runner container (defined in docker-compose.research.yml)
  e2e:
    environment:
      E2E_RUN_ID: ${E2E_RUN_ID:-e2e_local}
      INDEX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index
      TRIGRAPH_INDEX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/trigraph_edge
      OVERLAY_ROOT_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/overlay_uploads
      BASE_BUNDLE_ROOT_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/index/base_bundles
      UPLOADS_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/uploads
      KB_INBOX_DIR: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/inbox/base_updates
      BASE_KB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/base.sqlite
      OVERLAY_KB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay.sqlite
      INGEST_DB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay.sqlite
      SENSOR_DB_PATH: data/e2e_runs/${E2E_RUN_ID:-e2e_local}/kb/overlay_sensors.sqlite
      OCR_BACKEND: ${OCR_BACKEND:-tesseract}
      OCR_LANG: ${OCR_LANG:-english}
